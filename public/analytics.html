<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Link Analytics</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.colors.min.css" />
		<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
		<script async defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/ua-parser-js/dist/ua-parser.min.js"></script>
	</head>
	<body>
		<main class="container" x-data="analyticsPage()">
			<header>
				<nav>
					<ul>
						<li><a href="/">&larr; Back to Dashboard</a></li>
					</ul>
				</nav>
				<h1>Analytics for <code x-text="`/${slug}`"></code></h1>
			</header>

			<div x-show="loading" aria-busy="true">Fetching data...</div>

			<div x-show="error" x-text="error" role="alert"></div>

			<template x-if="!loading && !error">
				<div>
					<!-- <article>
						<h2>Clicks per Day</h2>
						<canvas id="clicksChart"></canvas>
					</article> -->

					<template x-for="click in clicks" :key="click.id">
						<article>
							<header>
								<p>
									<strong>Data click:</strong>
									<span x-text="new Date(click.clicked_at).toLocaleString('it-IT')"></span>
								</p>
							</header>
							<details>
								<summary>Mostra dettagli</summary>
								<div class="grid">
									<div>
										<h4>Parametri UTM</h4>
										<div x-show="Object.keys(click.parsed_metrics.utm).length > 0">
											<ul>
												<template x-for="[key, value] in Object.entries(click.parsed_metrics.utm)" :key="key">
													<li>
														<strong><span x-text="key"></span>:</strong>
														<span x-text="value"></span>
													</li>
												</template>
											</ul>
										</div>
										<div x-show="Object.keys(click.parsed_metrics.utm).length === 0">
											<p><i class="bi bi-bar-chart-fill"></i> Nessun parametro UTM registrato.</p>
										</div>
									</div>

									<div>
										<h4>Headers</h4>
										<div x-show="Object.keys(click.parsed_metrics.headers).length > 0">
											<div x-data="{ua: new UAParser(click.ua).getResult()}" class="pills-container">
												<template x-if="ua?.browser?.name">
													<kbd x-text="`${ua?.browser.name} ${ua?.browser.major || ''}`.trim()"></kbd>
												</template>

												<template x-if="ua?.os?.name">
													<kbd x-text="`${ua?.os.name} ${ua?.os.version || ''}`.trim()"></kbd>
												</template>
												<template x-if="ua?.device?.vendor || ua?.device?.model">
													<kbd x-text="[ua?.device.vendor, ua?.device.model].filter(Boolean).join(' ')"></kbd>
												</template>

												<template x-if="ua?.engine?.name">
													<kbd x-text="ua?.engine.name"></kbd>
												</template>
											</div>
											<ul>
												<template x-for="[key, value] in Object.entries(click.parsed_metrics.headers)" :key="key">
													<li>
														<strong><span x-text="key" class="uppercase"></span>:</strong>
														<span x-text="value || 'N/A'"></span>
													</li>
												</template>
											</ul>
										</div>
										<div x-show="Object.keys(click.parsed_metrics.headers).length === 0">
											<p>Nessun header registrato.</p>
										</div>
									</div>
								</div>
							</details>
						</article>
					</template>
				</div>
			</template>
		</main>

		<script>
			function analyticsPage() {
				return {
					slug: '',
					analytics: [],
					loading: true,
					error: '',
					init() {
						const urlParams = new URLSearchParams(window.location.search);
						this.slug = urlParams.get('slug');
						if (this.slug) {
							this.fetchAnalytics();
						} else {
							this.error = 'No link slug provided.';
							this.loading = false;
						}
					},
					async fetchAnalytics() {
						this.loading = true;
						this.error = '';
						try {
							const response = await fetch(`/api/analytics/${this.slug}`);
							if (!response.ok) {
								const errorData = await response.json();
								throw new Error(errorData.error || 'Failed to fetch analytics');
							}
							const res = await response.json();
							if (res.length === 0) return;
							this.analytics = res;

							console.log('raw', this.analytics);

							// this.renderChart();
						} catch (err) {
							console.error('Error fetching analytics:', err);
							this.error = err.message;
						} finally {
							this.loading = false;
						}
					},
					get clicks() {
						return this.analytics.map((click) => ({
							...click,
							parsed_metrics: JSON.parse(click.metrics),
							ua: new UAParser(JSON.parse(click.metrics).ua).getResult() || undefined,
						}));
					},
					renderChart() {
						const clicksByDay = this.analytics.reduce((acc, click) => {
							const date = new Date(click.clicked_at).toLocaleDateString();
							acc[date] = (acc[date] || 0) + 1;
							return acc;
						}, {});

						const ctx = document.getElementById('clicksChart').getContext('2d');
						new Chart(ctx, {
							type: 'bar',
							data: {
								labels: Object.keys(clicksByDay),
								datasets: [
									{
										label: 'Total Clicks',
										data: Object.values(clicksByDay),
										backgroundColor: 'rgba(75, 192, 192, 0.2)',
										borderColor: 'rgba(75, 192, 192, 1)',
										borderWidth: 1,
									},
								],
							},
							options: {
								scales: {
									y: {
										beginAtZero: true,
										ticks: {
											stepSize: 1,
										},
									},
								},
							},
						});
					},
				};
			}
		</script>
		<style>
			.uppercase {
				text-transform: uppercase;
			}
			.pills-container {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem; /* Spazio tra le pills */
				align-items: center;
				margin-top: 1rem;
			}
		</style>
	</body>
</html>
